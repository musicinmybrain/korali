#include "modules/solver/SARSA/SARSA.hpp"
#include "modules/conduit/conduit.hpp"

void korali::solver::SARSA::setInitialConfiguration()
{
 knlohmann::json problemConfig = (*_k)["Problem"];

 size_t actionSize = problemConfig["Action Vector Size"];
 size_t stateSize = problemConfig["State Vector Size"];

 printf("actionSize: %lu, stateSize: %lu\n", actionSize, stateSize);
}

void korali::solver::SARSA::runGeneration()
{
 if (_k->_currentGeneration == 1) setInitialConfiguration();

 _k->_logger->logInfo("Normal", "Running generation %lu...\n", _k->_currentGeneration);

 auto maxConcurrency = _conduit->maxConcurrency();
 printf("Max Concurrency: %lu\n", maxConcurrency);

 std::vector<Sample> samples(_environmentCount);
 std::vector<Environment> envs(_environmentCount);

 // Initializing Environments
 size_t curEnv = 0;
 while (curEnv < _environmentCount)
 {
  for (size_t i = 0; i < maxConcurrency && curEnv < _environmentCount; i++)
  {
   samples[curEnv]["Worker"] = i;
   samples[curEnv]["Sample Id"] = curEnv;
   samples[curEnv]["Module"] = "Problem";
   samples[curEnv]["Operation"] = "Run Environment";
   _conduit->start(samples[curEnv]);
   curEnv++;
  }
 }

 // Running action-state loop
 size_t finishedEnvs = 0;
 while (finishedEnvs < _environmentCount)
 {
   auto envId = _conduit->waitAny(samples);

   if (samples[envId]["Finished"] == true)
   {
    printf("Env Finished: %lu\n", envId);
    finishedEnvs++;
   }
   else
   {
    processEpisode(samples[envId], envs[envId]);
    _conduit->start(samples[envId]);
   }
 }

}

void korali::solver::SARSA::processEpisode(korali::Sample& sample, korali::solver::Environment& env)
{
 knlohmann::json problemConfig = (*_k)["Problem"];

 size_t actionSize = problemConfig["Action Vector Size"];
 size_t stateSize = problemConfig["State Vector Size"];

 std::string sampleString = "['State']";

 if ( korali::JsonInterface::isDefined(sample._js.getJson(), sampleString) == false)
   _k->_logger->logError("The RL problem requires that the environment function returns ['State'] values.\n");

 size_t resultStateVectorSize = sample["State"].size();

 if (resultStateVectorSize != stateSize)
  _k->_logger->logError("The returned state vector size (%lu) is different from the number of state variables (%lu)\n.", resultStateVectorSize, stateSize);
}

void korali::solver::SARSA::printGenerationBefore()
{
 _k->_logger->logInfo("Normal", "Preparing to start generation...\n");
}

void korali::solver::SARSA::printGenerationAfter()
{
 _k->_logger->logInfo("Normal", "Finished to generation %lu...\n", _k->_currentGeneration);
}

