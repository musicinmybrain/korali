#include "module.hpp"

knlohmann::json korali::__profiler;
std::chrono::time_point<std::chrono::high_resolution_clock> korali::_startTime;
std::chrono::time_point<std::chrono::high_resolution_clock> korali::_endTime;
double korali::_cumulativeTime;

// Module Include List

korali::Module *korali::Module::getModule(knlohmann::json &js, korali::Experiment *e)
{
  std::string moduleType = "Undefined";

  if (!isDefined(js, "Type"))
    KORALI_LOG_ERROR("No module type provided.\n");

  try
  {
    moduleType = js["Type"].get<std::string>();
  }
  catch (const std::exception &ex)
  {
    KORALI_LOG_ERROR("Could not parse module type: '%s'.\n%s", js["Type"].dump(2).c_str(), ex.what());
  }

  moduleType.erase(remove_if(moduleType.begin(), moduleType.end(), isspace), moduleType.end());

  try
  {
   eraseValue(js, "Type");
  }
  catch (const std::exception &ex)
  {
   KORALI_LOG_ERROR(" + Error erasing type value.\n%s", ex.what());
  }

  korali::Module *module = nullptr;

  // Module Selection List

  if (module == nullptr) KORALI_LOG_ERROR("Unrecognized module: %s.\n", moduleType.c_str());

  module->_k = e;
  module->applyVariableDefaults();
  module->applyModuleDefaults(js);
  module->setConfiguration(js);
  module->initialize();

  return module;
}

korali::Module *korali::Module::duplicate(korali::Module *src)
{
  knlohmann::json js;
  src->getConfiguration(js);
  return korali::Module::getModule(js, src->_k);
}
