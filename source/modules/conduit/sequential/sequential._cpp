#include "engine.hpp"
#include "modules/conduit/sequential/sequential.hpp"
#include "modules/experiment/experiment.hpp"
#include "modules/problem/problem.hpp"
#include "modules/solver/solver.hpp"


void korali::conduit::Sequential::processSample(korali::Sample& sample)
{
 // Instantiating Engine logger.
 _logger = new korali::Logger();

 korali::Engine* engine = _engineStack.top();

 auto js = knlohmann::json();
 js["Start Time"] = std::chrono::duration<double>(std::chrono::high_resolution_clock::now()-_startTime).count() + _cumulativeTime;

 size_t experimentId = sample["Experiment Id"];

 if (sample["Module"] == "Problem")
  engine->_experimentVector[experimentId]->_problem->runOperation(sample["Operation"], sample);

 if (sample["Module"] == "Solver")
  engine->_experimentVector[experimentId]->_solver->runOperation(sample["Operation"], sample);

 js["End Time"] = std::chrono::duration<double>(std::chrono::high_resolution_clock::now()-_startTime).count() + _cumulativeTime;
 js["Current Generation"] = engine->_currentExperiment->_currentGeneration;
 js["Solver Id"] = engine->_currentExperiment->_experimentId;
 __profiler["Timelines"]["Worker 0"] += js;
}

void korali::conduit::Sequential::stackEngine(korali::Engine* engine)
{
 _engineStack.push(engine);
}

void korali::conduit::Sequential::popEngine()
{
 _engineStack.pop();
}

void korali::conduit::Sequential::initServer()
{

}
