#include "modules/conduit/conduit.hpp"
#include "modules/experiment/experiment.hpp"
#include "modules/problem/bayesian/custom/custom.hpp"

void korali::problem::bayesian::Custom::initialize()
{
  korali::problem::Bayesian::initialize();

  if (_k->_variables.size() == 0) _k->_logger->logError("Bayesian inference problems require at least one variable.\n");
}

void korali::problem::bayesian::Custom::evaluateLoglikelihood(korali::Sample &sample)
{
  sample.run(_likelihoodModel);

  if (!sample.contains("logLikelihood")) _k->_logger->logError("The specified likelihood model did not assign the value: 'logLikelihood' to the sample.\n");
}

void korali::problem::bayesian::Custom::evaluateLoglikelihoodGradient(korali::Sample &sample)
{
  if (!sample.contains("logLikelihood Gradient")) _k->_logger->logError("The specified likelihood model did not assign the value: 'logLikelihood Gradient' to the sample.\n");
  if (sample["loglikelihood Gradient"].size() != _k->_variables.size()) _k->_logger->logError("Bayesian problem of type Custom requires likelihood gradient of size %zu (provided size %zu)\n", _k->_variables.size(), sample["loglikelihood Gradient"].size());
}

void korali::problem::bayesian::Custom::evaluateFisherInformation(korali::Sample &sample)
{
  if (!sample.contains("Fisher Information")) _k->_logger->logError("The specified likelihood model did not assign the value: 'Fisher Information' to the sample.\n");

  size_t Nth = _k->_variables.size();
  if (sample["Fisher Information"].size() != Nth) _k->_logger->logError("Bayesian problem of type Custom requires Fisher Information of size %zux%zu\n", Nth, Nth);

  for (size_t d = 0; d < Nth; ++d)
    if (sample["Fisher Information"][d].size() != Nth) _k->_logger->logError("Bayesian problem of type Custom requires Fisher Information of size %zux%zu\n", Nth, Nth);
}
