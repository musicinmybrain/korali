#ifndef _KORALI_HPP_
#define _KORALI_HPP_

#include <vector>
#include <functional>

// Include Files

namespace Korali
{

const double NaN = std::numeric_limits<double>::quiet_NaN();
const double Inf = std::numeric_limits<double>::infinity();
const double Lowest = std::numeric_limits<double>::lowest();
const double Max = std::numeric_limits<double>::max();

class Engine {

 public:

 nlohmann::json  _js;
 nlohmann::json& operator[](std::string key) { return _js[key]; }

 size_t _currentGeneration;
 size_t _consoleOutputFrequency;
 size_t _resultsOutputFrequency;
 size_t _computationalModelEvaluationCount;
 size_t _runId;
 std::string _runTimestamp;
 int _hasComputedGeneration;
 int _isFinished;
 size_t _seed;
 std::string _result_dir;

 std::string _solverType;
 std::string _conduitType;
 std::string _problemType;
 std::string _modelType;

 Korali::Conduit::Base* _conduit;
 Korali::Problem::Base* _problem;
 Korali::Solver::Base*  _solver;

 // Model Functions and constructors
 Engine();
 ~Engine();

 // Start functions
 void start(bool isDryRun);
 void run() { start(false); }
 void dry() { start(true);  }

 std::function<void(Korali::Model::Direct&)> _directModel;
 std::function<void(Korali::Model::Likelihood&)> _likelihoodModel;
 std::function<void(Korali::Model::Reference&)> _referenceModel;
 std::vector<std::function<void(Korali::Model::Constraint&)>> _constraints;

 void setDirectModel(std::function<void(Korali::Model::Direct&)> model);
 void setLikelihoodModel(std::function<void(Korali::Model::Likelihood&)> model);
 void setReferenceModel(std::function<void(Korali::Model::Reference&)> model);
 void addConstraint(std::function<void(Korali::Model::Constraint&)> constraint);

 // Python Configuration Binding Methods
 KoraliJsonWrapper _wr;
 KoraliJsonWrapper& getItem(const std::string& key)           { _wr._js = &(_js[key]); return _wr;}
 KoraliJsonWrapper& getItem(const unsigned long int& key)     { _wr._js = &(_js[key]); return _wr;}
 void setItem(const std::string& key, const std::string& val) { _js[key] = val; }
 void setItem(const std::string& key, const double& val)      { _js[key] = val; }
 void setItem(const std::string& key, const int& val)         { if(_js[key].is_boolean()) _js[key] = val == true; else _js[key] = val; }
 void setItem(const std::string& key, const bool& val)        { _js[key] = val; }

 void loadState(std::string fileName);
 void saveState(std::string fileName);
 void saveState(int fileId);

 // Serialization Methods
 void getConfiguration();
 void setConfiguration();
};

extern Engine* _k;

} // namespace Korali

#endif // _KORALI_HPP_
