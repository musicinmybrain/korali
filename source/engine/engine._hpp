#ifndef _KORALI_ENGINE_HPP_
#define _KORALI_ENGINE_HPP_

#include <vector>
#include <functional>
#include "sample/sample.hpp"
#include "variable/variable.hpp"
#include "module.hpp"

#undef _POSIX_C_SOURCE
#undef _XOPEN_SOURCE

namespace Korali
{

namespace Solver { class Base; }
namespace Problem { class Base; }
namespace Conduit { class Base; }

class Engine : public Korali::Module {

 public:

 // Start functions
 void initialize() override;
 void start(bool isDryRun);
 void run() { start(false); }
 void dry() { start(true);  }

 // Constructors
 Engine();
 Engine(nlohmann::json js);

 // Model Collection
 std::vector<std::function<void(Korali::Sample&)>> _models;

 // JSON-based configuration
 nlohmann::json  _js;

 // Python and Json Configuration Binding Methods
 nlohmann::json*  _opt;

 Engine& getItem(const std::string& key)                   { _opt = &((*_opt)[key]); return *this;}
 Engine& getItem(const unsigned long int& key)             { _opt = &((*_opt)[key]); return *this;}
 Engine& operator[](const std::string& key)                { _opt = &((*_opt)[key]); return *this;}
 Engine& operator[](const unsigned long int& key)          { _opt = &((*_opt)[key]); return *this;}

 void setItem(const std::string& key, const std::function<void(Korali::Sample&)> val);
 void setItem(const std::string& key, const std::string& val)         { (*_opt)[key] = val; _opt = &_js; }
 void setItem(const std::string& key, const double& val)              { (*_opt)[key] = val; _opt = &_js; }
 void setItem(const std::string& key, const int& val)                 { (*_opt)[key] = val; _opt = &_js; }
 void setItem(const std::string& key, const std::vector<double>& val) { (*_opt)[key] = val; _opt = &_js; }

 void setItem(const int& key, const std::function<void(Korali::Sample&)> val);
 void setItem(const int& key, const std::string& val)                 { (*_opt)[key] = val; _opt = &_js; }
 void setItem(const int& key, const double& val)                      { (*_opt)[key] = val; _opt = &_js; }
 void setItem(const int& key, const int& val)                         { (*_opt)[key] = val; _opt = &_js; }

 double getValue();
 bool getBoolean();
 std::string getString();
 std::vector<double> getArray();

 void operator=(const std::function<void(Korali::Sample&)> val);
 void operator=(const std::string& val)         { (*_opt) = val; _opt = &_js; }
 void operator=(const double& val)              { (*_opt) = val; _opt = &_js; }
 void operator=(const int& val)                 { (*_opt) = val; _opt = &_js; }
 void operator=(const std::vector<double>& val) { (*_opt) = val; _opt = &_js; }

 // State save/load methods
 bool isExecutionFinished();
 void loadState(std::string fileName);
 void saveState(std::string fileName);
 void saveState(int fileId);
};

} // namespace Korali

#endif // _KORALI_ENGINE_HPP_
