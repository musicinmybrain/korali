#ifndef _KORALI_ENGINE_HPP_
#define _KORALI_ENGINE_HPP_

#include <vector>
#include <functional>
#include <chrono>
#include "engine/sample/sample.hpp"
#include "engine/variable/variable.hpp"
#include "auxiliar/koraliJson.hpp"
#include "module.hpp"

namespace korali
{

class Solver;
class Problem;
class Conduit;

class Engine : public korali::Module {

 public:

 // Start functions
 void initialize() override;

 void run(size_t count, bool isDryRun);
 void runSingle() { run(1, false); }
 void runMultiple(size_t count) { run(count, false); }
 void runDry() { run(1, true); }

 // Constructors
 Engine();
 Engine(nlohmann::json js);

 // JSON-based configuration
 korali::KoraliJson  _js;

 // Multiple Solver Variables/Functions
 cothread_t _thread;
 size_t _solverCount;

 pybind11::object getItem(pybind11::object key);
 void setItem(pybind11::object key, pybind11::object val);

 nlohmann::json& operator[](const std::string& key);
 nlohmann::json& operator[](const unsigned long int& key);

 // State save/load methods
 void loadState(std::string fileName);
 void saveState(korali::Solver*, std::string dirName, std::string fileName);
 void saveState(korali::Solver*, std::string dirName, int fileId);

 // Communicator Methods
 long int getMPICommPointer();
};

} // namespace korali

#endif // _KORALI_ENGINE_HPP_
