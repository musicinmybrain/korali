#include "korali.hpp"
#include <sys/wait.h>

using namespace Korali::Conduit;

void External::initialize()
{
 if (_concurrentJobs < 1) koraliError("You need to define at least 1 concurrent job(s) for external models \n");
 for (int i = 0; i < _concurrentJobs; i++) _pipeDescriptors.push_back(std::vector<int>(2));
 for (int i = 0; i < _concurrentJobs; i++) _launcherQueue.push(i);
}

void External::finalize()
{
}

void External::evaluateSample(double* sampleArray, size_t sampleId)
{
 while (_launcherQueue.empty()) checkProgress();

 int launcherId = _launcherQueue.front(); _launcherQueue.pop();

 // Opening Inter-process communicator pipes
 if (pipe(_pipeDescriptors[launcherId].data()) == -1) koraliError("Unable to create inter-process pipe. \n");

 pid_t processId = fork();

 _launcherIdToSamplerIdMap[launcherId] = sampleId;
 _launcherIdToProcessIdMap[launcherId] = processId;
 _processIdMapToLauncherIdMap[processId] = launcherId;

 if (processId == 0)
 {
  std::vector<double> sampleVector;
  for (size_t i = 0; i < _k->N; i++) sampleVector.push_back(sampleArray[i]);

  _k->_problem->runModel(sampleVector, sampleId);
  double fitness = _k->_problem->evaluateFitness();

  write(_pipeDescriptors[launcherId][1], &fitness, sizeof(double));
  exit(0);
 }

 _k->_functionEvaluationCount++;

}

void External::checkProgress()
{
 int status;
 pid_t processId;

 processId = wait(&status);
 if (processId > 0)
 {
  int launcherId = _processIdMapToLauncherIdMap[processId];
  double fitness = 0.0;
  size_t sampleId = _launcherIdToSamplerIdMap[launcherId];
  read(_pipeDescriptors[launcherId][0], &fitness, sizeof(double));
  _k->_solver->processSample(sampleId, fitness);
  close(_pipeDescriptors[launcherId][1]); // Closing pipes
  close(_pipeDescriptors[launcherId][0]); // Closing pipes
  _launcherQueue.push(launcherId);
 }

}

bool External::isRoot()
{
 return true;
}

void External::abort()
{
 exit(-1);
}
