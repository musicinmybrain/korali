#include "problems/bayesian/base.hpp"
#include "conduits/base.hpp"
#include "engine/engine.hpp"

void Korali::Problem::Bayesian::Base::initialize()
{
  if (_k->_variables.size() == 0) Korali::logError("Bayesian problems require at least one variable.\n");
}

void Korali::Problem::Bayesian::Base::evaluateLogPrior(Korali::Sample& sample)
{
  double logPrior = 0.0;
  for (size_t i = 0; i < sample.getSampleData().size(); i++)
    logPrior += _k->_variables[i]->_priorDistribution->getLogDensity(sample[i]);

  sample.setResult(logPrior);
}

void Korali::Problem::Bayesian::Base::evaluateLogPosterior(Korali::Sample& sample)
{
  evaluateLogPrior(sample);
  double logPrior = sample.getResult()[0];

  evaluateLogLikelihood(sample);
  double logLikelihood = sample.getResult()[0];

  double logPosterior = logPrior + logLikelihood;

  if(std::isnan(logPosterior) == true) Korali::logError("Sample %zu returned NaN logPosterior evaluation.\n", sample.getSampleId());

  sample.setResult(logPosterior);
}

bool Korali::Problem::Bayesian::Base::isSampleFeasible(Korali::Sample& sample)
{
  for (size_t i = 0; i < sample.getSampleData().size(); i++)
    if (isfinite(_k->_variables[i]->_priorDistribution->getLogDensity(sample[i])) == false) return false;
  return true;
}

void Korali::Problem::Bayesian::Base::evaluateSample(Korali::Sample& sample)
{
 evaluateLogPosterior(sample);
}
