#include "problems/direct/optimization/optimization.hpp"
#include "conduits/base.hpp"

void Korali::Problem::Direct::Optimization::initialize()
{
 if (_k->_variables.size() == 0) Korali::logError("Optimization problems require at least one variable.\n");
}

double Korali::Problem::Direct::Optimization::getBasicEvaluation(Korali::Sample& sample)
{
 double fitnessSign = _objective == "Maximize" ? 1.0 : -1.0;

 _k->_conduit->runModel(_objectiveFunction, sample);
 std::vector<double> result = sample.getResult();
 if (result.size() != 1) Korali::logError("Optimization problems require exactly 1 result. Provided: %lu.\n", result.size());

 return fitnessSign * result[0];
}

std::vector<double> Korali::Problem::Direct::Optimization::getConstraintsEvaluation(Korali::Sample& sample)
{
 std::vector<double> evaluations;

 for (size_t i = 0; i < _constraints.size(); i++)
 {
  _k->_conduit->runModel(_constraints[i], sample);
  std::vector<double> constraintResult = sample.getResult();
  if (constraintResult.size() != 1) Korali::logError("Costraint evaluations should return exactly 1 result. Provided: %lu.\n", constraintResult.size());
  evaluations.push_back(constraintResult[0]);
  _constraintEvaluationCount++;
 }

 return evaluations;
}

void Korali::Problem::Direct::Optimization::evaluateConstraints(Korali::Sample& sample)
{
 sample.setResult(dynamic_cast<Korali::Problem::Direct::Optimization*>(_k->_problem)->getConstraintsEvaluation(sample));
}
