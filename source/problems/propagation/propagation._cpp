#include "problems/propagation/propagation.hpp"
#include "conduits/base.hpp"

void Korali::Problem::Propagation::initialize()
{
  if (_k->_variables.size() == 0) Korali::logError("Propagation problems require at least one variable.\n");

  // Validate the _loadedValues dimensions
  size_t Ns = _k->_variables[0]->_loadedValues.size();
  for (size_t i = 1; i < _k->_variables.size(); i++){
    if (_k->_variables[i]->_loadedValues.size() != Ns)  Korali::logError("All 'Loaded Values' must have the same length ");
  }
}

double Korali::Problem::Propagation::getBasicEvaluation(Korali::Sample& sample)
{
 Korali::logError("Propagation problem cannot produce basic sample evaluations.\n");
 return 0.0;
}

void Korali::Problem::Propagation::propagate(Korali::Sample& sample)
{
 _k->_conduit->runModel(_propagationModel, sample);
 std::vector<double> result = sample.getResult();
 if (result.size() != 0) Korali::logError("Propagation model should return no result. Provided: %lu.\n", result.size());
}

void Korali::Problem::Propagation::performPropagation(Korali::Sample& sample)
{
 dynamic_cast<Korali::Problem::Propagation*>(_k->_problem)->propagate(sample);
}
