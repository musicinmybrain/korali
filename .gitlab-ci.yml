include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.cscs.yml'

  
stages:
  - build # build stage is running on the Kubernetes cluster
  - test  # test stage is running on Piz Daint

  
variables: # apply to all jobs
  PERSIST_IMAGE_NAME: korali_cscs_ci_cpu
  #PERSIST_IMAGE_NAME_GPU: korali_cscs_ci_gpu:
  VERBOSE: 'YES' # debugging
  SARUS_VERBOSE: 'YES' # debugging

  
build_cpu:
  tags:
    - docker_jfrog
  stage: build
  script:
    # we are using a Dockerfile that contains the real build instructions, this script will be ignored by the docker_jfrog runner if DOCKERFILE is set
    - "true"
  variables:
    DOCKERFILE:  docker/Dockerfile_cscs_ci.deploy.cpu
    
#build_gpu:
  #tags:
    #- docker_jfrog
  #stage: build
  #script:
    ## we are using a Dockerfile that contains the real build instructions, this script will be ignored by the docker_jfrog runner if DOCKERFILE is set
    #- "true"
  #variables:
    #DOCKERFILE:  docker/Dockerfile_cscs_ci.deploy.gpu
    
.test_korali:
  extends: .daint
  stage: test
  variables:
    PULL_IMAGE: 'YES'
    CSCS_REGISTRY_LOGIN: 'YES'
    # SLURM_TIMELIMIT: '15:00'

run_non_mpi_cpu_test:
  extends: .test_korali
  image: art.cscs.ch/contbuild/testing/anfink/${PERSIST_IMAGE_NAME}
  script:
    - echo "Hello from korali test in Sarus container on node ${SLURMD_NODENAME} (node ID ${SLURM_NODEID}, proc ID ${SLURM_PROCID}, replacing MPI ${USE_MPI})"
    - cd /home/ubuntu/korali/examples/features/running.cxx && make -j4 && ./run-cmaes
  variables:
    USE_MPI: 'NO'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 1
    SLURM_CONSTRAINT: 'mc'

run_mpi_cpu_test:
  extends: .test_korali
  image: art.cscs.ch/contbuild/testing/anfink/${PERSIST_IMAGE_NAME}
  script:
    - echo "Hello from korali test in Sarus container on node ${SLURMD_NODENAME} (node ID ${SLURM_NODEID}, proc ID ${SLURM_PROCID}, replacing MPI ${USE_MPI})"
    - cd /home/ubuntu/korali/examples/features/running.mpi.cxx && make -j4 && ./run-cmaes 4
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 9
    SLURM_CONSTRAINT: 'mc'

#run_mpi_gpu_test:
  #extends: .test_korali
  #image: art.cscs.ch/contbuild/testing/anfink/${PERSIST_IMAGE_NAME_GPU}
  #script:
    #- echo "Hello from korali test in Sarus container  on node ${SLURMD_NODENAME} (node ID ${SLURM_NODEID}, proc ID ${SLURM_PROCID}, replacing MPI ${USE_MPI})"
  #variables:
    #USE_MPI: 'YES'
    #SLURM_JOB_NUM_NODES: 1
    #SLURM_NTASKS: 9
    #SLURM_CONSTRAINT: 'gpu'
